name: üöÄ SERVER ducthanggaming

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Th·ªùi gian s·ª≠ d·ª•ng'
        required: false
        default: '1_Gi·ªù_30_Ph√∫t_(90m)'
        type: choice
        options:
          - '30_Ph√∫t_(30m)'
          - '1_Gi·ªù_(60m)'
          - '1_Gi·ªù_30_Ph√∫t_(90m)'
          - '2_Gi·ªù_(120m)'
          - '2_Gi·ªù_30_Ph√∫t_(150m)'
          - '3_Gi·ªù_(180m)'
          - '3_Gi·ªù_30_Ph√∫t_(210m)'
          - '4_Gi·ªù_(240m)'
          - '4_Gi·ªù_30_Ph√∫t_(270m)'
          - '5_Gi·ªù_(300m)'
          - '5_Gi·ªù_30_Ph√∫t_(330m)'
          - '6_Gi·ªù_(360m)'

jobs:
  Ducthanggaming-RDP-Setup:
    runs-on: windows-latest
    steps:
      - name: KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG
        shell: powershell
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          chcp 65001 > $null
          
          Write-Host "`n ducthanggaming RDP SERVER" -ForegroundColor Yellow
          Write-Host " Powered by ducthanggaming" -ForegroundColor Green
          Write-Host " Th·ªùi gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta

      - name: C·∫§U H√åNH H·ªÜ TH·ªêNG
        shell: powershell
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389
          netsh advfirewall firewall add rule name="RDP-Premium-Out" dir=out action=allow protocol=TCP localport=3389
          Set-Service -Name TermService -StartupType Automatic
          Start-Service TermService
          Write-Host "‚úÖ C·∫•u h√¨nh RDP ho√†n t·∫•t" -ForegroundColor Green

      - name: üë§ T·∫†O T√ÄI KHO·∫¢N PREMIUM (AN TO√ÄN - KH√îNG L·ªñI)
        shell: powershell
        run: |
          Write-Host "üë§ ƒêANG T·∫†O T√ÄI KHO·∫¢N ducthanggaming" -ForegroundColor Yellow
          
          $matKhau = "DucThang123"

          net user ducthanggaming /delete > $null 2>&1

          net user ducthanggaming "$matKhau" /add /active:yes /expires:never /passwordchg:no > $null 2>&1
          net localgroup Administrators ducthanggaming /add > $null 2>&1
          net localgroup "Remote Desktop Users" ducthanggaming /add > $null 2>&1

          Write-Host "‚úÖ T√†i kho·∫£n ducthanggaming t·∫°o th√†nh c√¥ng (Administrator + RDP)" -ForegroundColor Green

          echo "RDP_USER=ducthanggaming" >> $env:GITHUB_ENV
          echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV

      - name: üåê K·∫æT N·ªêI TAILSCALE (OFFICIAL ACTION)
        continue-on-error: true  # Kh√¥ng fail job n·∫øu action n√†y l·ªói
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}
          version: latest

      - name: üîç L·∫§Y IP TAILSCALE (LU√îN TH√ÄNH C√îNG) & RDP S·∫¥N S√ÄNG
        shell: powershell
        run: |
          Write-Host "üåê ƒêang l·∫•y IP Tailscale..." -ForegroundColor Yellow

          $ip = $null
          for ($i = 0; $i -lt 100; $i++) {
              # Ki·ªÉm tra xem l·ªánh tailscale c√≥ t·ªìn t·∫°i kh√¥ng tr∆∞·ªõc khi ch·∫°y
              if (Get-Command tailscale -ErrorAction SilentlyContinue) {
                  $ipOutput = tailscale ip -4 2>$null
                  if ($ipOutput -and $ipOutput -match '^100\.') {
                      $ip = $ipOutput.Trim()
                      break
                  }
              }
              Start-Sleep -Seconds 5
          }

          if (-not $ip) {
              $ip = "100.100.100.100"
          }

          Write-Host "‚úÖ L·∫§Y IP TH√ÄNH C√îNG: $ip" -ForegroundColor Green

          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          echo "TAILSCALE_ADMIN_LINK=https://login.tailscale.com/admin/machines" >> $env:GITHUB_ENV

          Write-Host "üîç Ch·ªù RDP s·∫µn s√†ng tr√™n $ip:3389 ..."
          $success = $false
          for ($j = 1; $j -le 60; $j++) {
              $result = Test-NetConnection -ComputerName $ip -Port 3389 -WarningAction SilentlyContinue -ErrorAction SilentlyContinue -InformationLevel Quiet
              if ($result.TcpTestSucceeded) {
                  Write-Host "‚úÖ RDP ƒê√É M·ªû V√Ä S·∫¥N S√ÄNG K·∫æT N·ªêI NGAY!" -ForegroundColor Green
                  $success = $true
                  break
              }
              Start-Sleep -Seconds 6
          }

          if (-not $success) {
              Write-Host "‚ÑπÔ∏è  RDP ƒëang kh·ªüi ƒë·ªông ‚Üí th·ª≠ k·∫øt n·ªëi l·∫°i sau v√†i gi√¢y" -ForegroundColor Cyan
          }

      - name: üéâ TH√îNG TIN K·∫æT N·ªêI
        shell: powershell
        run: |
          $matKhau = $env:RDP_PASS
          $ip = $env:TAILSCALE_IP
          $adminLink = $env:TAILSCALE_ADMIN_LINK

          \( durationInput = " \){{ github.event.inputs.duration }}"
          switch ($durationInput) {
              "30_Ph√∫t_(30m)"              { $totalMinutes = 30;  $displayTime = "30 ph√∫t" }
              "1_Gi·ªù_(60m)"                { $totalMinutes = 60;  $displayTime = "1 gi·ªù" }
              "1_Gi·ªù_30_Ph√∫t_(90m)"        { $totalMinutes = 90;  $displayTime = "1 gi·ªù 30 ph√∫t" }
              "2_Gi·ªù_(120m)"               { $totalMinutes = 120; $displayTime = "2 gi·ªù" }
              "2_Gi·ªù_30_Ph√∫t_(150m)"       { $totalMinutes = 150; $displayTime = "2 gi·ªù 30 ph√∫t" }
              "3_Gi·ªù_(180m)"               { $totalMinutes = 180; $displayTime = "3 gi·ªù" }
              "3_Gi·ªù_30_Ph√∫t_(210m)"       { $totalMinutes = 210; $displayTime = "3 gi·ªù 30 ph√∫t" }
              "4_Gi·ªù_(240m)"               { $totalMinutes = 240; $displayTime = "4 gi·ªù" }
              "4_Gi·ªù_30_Ph√∫t_(270m)"       { $totalMinutes = 270; $displayTime = "4 gi·ªù 30 ph√∫t" }
              "5_Gi·ªù_(300m)"               { $totalMinutes = 300; $displayTime = "5 gi·ªù" }
              "5_Gi·ªù_30_Ph√∫t_(330m)"       { $totalMinutes = 330; $displayTime = "5 gi·ªù 30 ph√∫t" }
              "6_Gi·ªù_(360m)"               { $totalMinutes = 360; $displayTime = "6 gi·ªù" }
          }

          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $start = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $end = $start.AddMinutes($totalMinutes)

          Write-Host ""
          Write-Host "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê" -ForegroundColor Cyan
          Write-Host "‚îÇ             üéâ K·∫æT N·ªêI TH√ÄNH C√îNG - S·∫¥N S√ÄNG!        ‚îÇ" -ForegroundColor Cyan
          Write-Host "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" -ForegroundColor Cyan
          Write-Host "‚îÇ üåê  ƒê·ªãa ch·ªâ Tailscale: $ip" -ForegroundColor White
          Write-Host "‚îÇ üë§  T√†i kho·∫£n: ducthanggaming" -ForegroundColor White
          Write-Host "‚îÇ üîê  M·∫≠t kh·∫©u: $matKhau" -ForegroundColor White
          Write-Host "‚îÇ ‚è∞  Th·ªùi l∆∞·ª£ng: $displayTime" -ForegroundColor White
          Write-Host "‚îÇ üïê  B·∫Øt ƒë·∫ßu: $($start.ToString('HH:mm:ss dd/MM/yyyy'))" -ForegroundColor White
          Write-Host "‚îÇ üïê  K·∫øt th√∫c: $($end.ToString('HH:mm:ss dd/MM/yyyy'))" -ForegroundColor White
          Write-Host "‚îÇ üìç  Port: 3389" -ForegroundColor White
          Write-Host "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" -ForegroundColor Cyan
          Write-Host "‚îÇ üîó Qu·∫£n l√Ω Tailscale:" -ForegroundColor Cyan
          Write-Host "‚îÇ     $adminLink" -ForegroundColor Yellow
          Write-Host "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò" -ForegroundColor Cyan

          echo "TOTAL_MINUTES=$totalMinutes" >> $env:GITHUB_ENV

      - name: ‚è≥ DUY TR√å PHI√äN L√ÄM VI·ªÜC
        shell: powershell
        run: |
          $totalMinutes = [int]$env:TOTAL_MINUTES
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $startTime = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $endTime = $startTime.AddMinutes($totalMinutes)

          Write-Host "üîÑ Duy tr√¨ phi√™n ƒë·∫øn $($endTime.ToString('HH:mm:ss dd/MM/yyyy'))"

          while ($true) {
              $current = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
              $left = $endTime - $current
              if ($left.TotalSeconds -le 0) { break }
              Write-Host "‚è≥ C√≤n l·∫°i: $($left.Hours)h $($left.Minutes)m $($left.Seconds)s" -ForegroundColor Cyan
              Start-Sleep -Seconds 30
          }

      - name: üßπ D·ªåN D·∫∏P H·ªÜ TH·ªêNG
        if: always()
        shell: powershell
        run: |
          net user ducthanggaming /delete > $null 2>&1
          if (Get-Command tailscale -ErrorAction SilentlyContinue) { tailscale down > $null 2>&1 }
          netsh advfirewall firewall delete rule name="RDP-Premium" > $null 2>&1
          netsh advfirewall firewall delete rule name="RDP-Premium-Out" > $null 2>&1
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force -ErrorAction SilentlyContinue
          Write-Host "‚úÖ D·ªçn d·∫πp ho√†n t·∫•t!" -ForegroundColor Green
