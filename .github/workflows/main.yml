name: üöÄ SERVER ducthanggaming

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Th·ªùi gian s·ª≠ d·ª•ng'
        required: false
        default: '1_Gi·ªù_30_Ph√∫t_(90m)'
        type: choice
        options:
          - '30_Ph√∫t_(30m)'
          - '1_Gi·ªù_(60m)'
          - '1_Gi·ªù_30_Ph√∫t_(90m)'
          - '2_Gi·ªù_(120m)'
          - '2_Gi·ªù_30_Ph√∫t_(150m)'
          - '3_Gi·ªù_(180m)'
          - '3_Gi·ªù_30_Ph√∫t_(210m)'
          - '4_Gi·ªù_(240m)'
          - '4_Gi·ªù_30_Ph√∫t_(270m)'
          - '5_Gi·ªù_(300m)'
          - '5_Gi·ªù_30_Ph√∫t_(330m)'
          - '6_Gi·ªù_(360m)'

jobs:
  Ducthanggaming-RDP-Setup:
    runs-on: windows-latest
    steps:
      - name: KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG
        shell: powershell
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          chcp 65001 > $null
          
          Write-Host "`n ducthanggaming RDP SERVER" -ForegroundColor Yellow
          Write-Host " Powered by ducthanggaming" -ForegroundColor Green
          Write-Host " Th·ªùi gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta

      - name: C·∫§U H√åNH H·ªÜ TH·ªêNG
        shell: powershell
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389
          netsh advfirewall firewall add rule name="RDP-Premium-Out" dir=out action=allow protocol=TCP localport=3389
          Set-Service -Name TermService -StartupType Automatic
          Start-Service TermService
          Write-Host "‚úÖ C·∫•u h√¨nh RDP ho√†n t·∫•t" -ForegroundColor Green

      - name: üë§ T·∫†O T√ÄI KHO·∫¢N PREMIUM (·ªîN ƒê·ªäNH - KH√îNG EXIT 1)
        shell: powershell
        run: |
          Write-Host "üë§ ƒêANG T·∫†O T√ÄI KHO·∫¢N ducthanggaming" -ForegroundColor Yellow
          
          function New-PremiumPassword {
              $upper = 'ABCDEFGHJKLMNPQRSTUVWXYZ'
              $lower = 'abcdefghijkmnpqrstuvwxyz'
              $numbers = '23456789'
              $all = $upper + $lower + $numbers

              $pw = @()
              $pw += $upper[(Get-Random -Maximum $upper.Length)]
              $pw += $lower[(Get-Random -Maximum $lower.Length)]
              $pw += $numbers[(Get-Random -Maximum $numbers.Length)]
              for ($i = 1; $i -le 5; $i++) { $pw += $all[(Get-Random -Maximum $all.Length)] }
              return (-join ($pw | Sort-Object {Get-Random}))
          }

          $matKhau = if ($env:CUSTOM_RDP_PASS) { $env:CUSTOM_RDP_PASS } else { New-PremiumPassword }

          # X√≥a user c≈© n·∫øu t·ªìn t·∫°i
          net user ducthanggaming /delete > $null 2>&1

          # T·∫°o user m·ªõi - d√πng net user (·ªïn ƒë·ªãnh nh·∫•t tr√™n GitHub runners)
          net user ducthanggaming "$matKhau" /add /active:yes /expires:never /passwordchg:no
          if ($LASTEXITCODE -ne 0) {
              Write-Host "‚ö†Ô∏è  T·∫°o user th·∫•t b·∫°i, th·ª≠ l·∫°i v·ªõi m·∫≠t kh·∫©u ƒë∆°n gi·∫£n h∆°n..." -ForegroundColor Yellow
              $matKhau = "DucThang123!"
              net user ducthanggaming "$matKhau" /add /active:yes /expires:never /passwordchg:no
          }

          # Th√™m quy·ªÅn Admin v√† RDP
          net localgroup Administrators ducthanggaming /add > $null 2>&1
          net localgroup "Remote Desktop Users" ducthanggaming /add > $null 2>&1

          Write-Host "‚úÖ T√†i kho·∫£n ducthanggaming ƒë√£ t·∫°o th√†nh c√¥ng!" -ForegroundColor Green

          echo "RDP_USER=ducthanggaming" >> $env:GITHUB_ENV
          echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV

      - name: üåê C√ÄI ƒê·∫∂T & K·∫æT N·ªêI TAILSCALE (KH√îNG EXIT 1 - T·ª∞ ƒê·ªòNG FALLBACK)
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        shell: powershell
        run: |
          Write-Host "üåê B·∫Øt ƒë·∫ßu c√†i ƒë·∫∑t Tailscale..." -ForegroundColor Yellow

          if (-not $env:TAILSCALE_AUTH_KEY) {
              Write-Host "‚ö†Ô∏è  Kh√¥ng c√≥ TAILSCALE_AUTH_KEY ‚Üí b·ªè qua Tailscale, d√πng localhost fallback" -ForegroundColor Yellow
              echo "TAILSCALE_IP=127.0.0.1" >> $env:GITHUB_ENV
              return
          }

          $msiUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $msiPath = "$env:TEMP\tailscale.msi"

          try {
              Invoke-WebRequest -Uri $msiUrl -OutFile $msiPath -UseBasicParsing -TimeoutSec 60
          } catch {
              Write-Host "‚ö†Ô∏è  T·∫£i Tailscale th·∫•t b·∫°i ‚Üí d√πng localhost fallback" -ForegroundColor Yellow
              echo "TAILSCALE_IP=127.0.0.1" >> $env:GITHUB_ENV
              return
          }

          Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $msiPath -Force -ErrorAction SilentlyContinue

          Start-Sleep -Seconds 15

          $tailscaleExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
          if (-not (Test-Path $tailscaleExe)) {
              Write-Host "‚ö†Ô∏è  Kh√¥ng t√¨m th·∫•y Tailscale sau c√†i ƒë·∫∑t ‚Üí d√πng localhost" -ForegroundColor Yellow
              echo "TAILSCALE_IP=127.0.0.1" >> $env:GITHUB_ENV
              return
          }

          # K·∫øt n·ªëi Tailscale (kh√¥ng exit n·∫øu l·ªói)
          & $tailscaleExe up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=ducthanggaming-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset --force-reauth

          Start-Sleep -Seconds 10

          # L·∫•y IP (retry nhi·ªÅu l·∫ßn)
          $ip = $null
          for ($i = 0; $i -lt 40; $i++) {
              $output = & $tailscaleExe ip -4 2>$null
              if (\( output -match '^(100\.\d{1,3}\.\d{1,3}\.\d{1,3}) \)') {
                  $ip = $Matches[1]
                  break
              }
              Start-Sleep -Seconds 3
          }

          if ($ip) {
              Write-Host "‚úÖ Tailscale IP: $ip" -ForegroundColor Green
              echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          } else {
              Write-Host "‚ö†Ô∏è  Kh√¥ng l·∫•y ƒë∆∞·ª£c IP Tailscale ‚Üí d√πng localhost fallback" -ForegroundColor Yellow
              echo "TAILSCALE_IP=127.0.0.1" >> $env:GITHUB_ENV
          }

      - name: üîç KI·ªÇM TRA K·∫æT N·ªêI RDP (KH√îNG EXIT 1 - T·ª∞ ƒê·ªòNG B·ªé QUA N·∫æU C·∫¶N)
        shell: powershell
        run: |
          $ip = $env:TAILSCALE_IP
          Write-Host "üîç Ki·ªÉm tra k·∫øt n·ªëi RDP t·ªõi $ip:3389 ..."

          $success = $false
          for ($i = 1; $i -le 30; $i++) {
              $result = Test-NetConnection -ComputerName $ip -Port 3389 -WarningAction SilentlyContinue -ErrorAction SilentlyContinue
              if ($result.TcpTestSucceeded) {
                  Write-Host "‚úÖ K·∫øt n·ªëi RDP th√†nh c√¥ng!" -ForegroundColor Green
                  $success = $true
                  break
              }
              Start-Sleep -Seconds 5
          }

          if (-not $success) {
              Write-Host "‚ö†Ô∏è  Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c RDP ngay ‚Üí v·∫´n ti·∫øp t·ª•c (c√≥ th·ªÉ k·∫øt n·ªëi sau v√†i ph√∫t)" -ForegroundColor Yellow
          }

      - name: üéâ TH√îNG TIN K·∫æT N·ªêI
        shell: powershell
        run: |
          $matKhau = $env:RDP_PASS
          $ip = $env:TAILSCALE_IP

          if ($ip -eq "127.0.0.1") {
              Write-Host "‚ö†Ô∏è  ƒêang d√πng ch·∫ø ƒë·ªô localhost (Tailscale kh√¥ng kh·∫£ d·ª•ng)" -ForegroundColor Yellow
          }

          \( durationInput = " \){{ github.event.inputs.duration }}"
          switch ($durationInput) {
              "30_Ph√∫t_(30m)"              { $totalMinutes = 30;  $displayTime = "30 ph√∫t" }
              "1_Gi·ªù_(60m)"                { $totalMinutes = 60;  $displayTime = "1 gi·ªù" }
              "1_Gi·ªù_30_Ph√∫t_(90m)"        { $totalMinutes = 90;  $displayTime = "1 gi·ªù 30 ph√∫t" }
              "2_Gi·ªù_(120m)"               { $totalMinutes = 120; $displayTime = "2 gi·ªù" }
              "2_Gi·ªù_30_Ph√∫t_(150m)"       { $totalMinutes = 150; $displayTime = "2 gi·ªù 30 ph√∫t" }
              "3_Gi·ªù_(180m)"               { $totalMinutes = 180; $displayTime = "3 gi·ªù" }
              "3_Gi·ªù_30_Ph√∫t_(210m)"       { $totalMinutes = 210; $displayTime = "3 gi·ªù 30 ph√∫t" }
              "4_Gi·ªù_(240m)"               { $totalMinutes = 240; $displayTime = "4 gi·ªù" }
              "4_Gi·ªù_30_Ph√∫t_(270m)"       { $totalMinutes = 270; $displayTime = "4 gi·ªù 30 ph√∫t" }
              "5_Gi·ªù_(300m)"               { $totalMinutes = 300; $displayTime = "5 gi·ªù" }
              "5_Gi·ªù_30_Ph√∫t_(330m)"       { $totalMinutes = 330; $displayTime = "5 gi·ªù 30 ph√∫t" }
              "6_Gi·ªù_(360m)"               { $totalMinutes = 360; $displayTime = "6 gi·ªù" }
          }

          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $start = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $end = $start.AddMinutes($totalMinutes)

          Write-Host ""
          Write-Host "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê" -ForegroundColor Cyan
          Write-Host "‚îÇ                 üéâ K·∫æT N·ªêI S·∫¥N S√ÄNG!                 ‚îÇ" -ForegroundColor Cyan
          Write-Host "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" -ForegroundColor Cyan
          Write-Host "‚îÇ üåê  ƒê·ªãa ch·ªâ: $ip" -ForegroundColor White
          Write-Host "‚îÇ üë§  T√†i kho·∫£n: ducthanggaming" -ForegroundColor White
          Write-Host "‚îÇ üîê  M·∫≠t kh·∫©u: $matKhau" -ForegroundColor White
          Write-Host "‚îÇ ‚è∞  Th·ªùi l∆∞·ª£ng: $displayTime" -ForegroundColor White
          Write-Host "‚îÇ üïê  B·∫Øt ƒë·∫ßu: $($start.ToString('HH:mm:ss dd/MM/yyyy'))" -ForegroundColor White
          Write-Host "‚îÇ üïê  K·∫øt th√∫c: $($end.ToString('HH:mm:ss dd/MM/yyyy'))" -ForegroundColor White
          Write-Host "‚îÇ üìç  Port: 3389" -ForegroundColor White
          Write-Host "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò" -ForegroundColor Cyan

          echo "TOTAL_MINUTES=$totalMinutes" >> $env:GITHUB_ENV

      - name: ‚è≥ DUY TR√å PHI√äN L√ÄM VI·ªÜC
        shell: powershell
        run: |
          $totalMinutes = [int]$env:TOTAL_MINUTES
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $startTime = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $endTime = $startTime.AddMinutes($totalMinutes)

          Write-Host "üîÑ Duy tr√¨ phi√™n ƒë·∫øn: $($endTime.ToString('HH:mm:ss dd/MM/yyyy'))"

          while ($true) {
              $current = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
              $left = $endTime - $current
              if ($left.TotalSeconds -le 0) { break }
              Write-Host "‚è≥ C√≤n l·∫°i: $($left.Hours)h $($left.Minutes)m $($left.Seconds)s" -ForegroundColor Cyan
              Start-Sleep -Seconds 30
          }

          Write-Host "üéØ ƒê√£ h·∫øt th·ªùi gian duy tr√¨!"

      - name: üßπ D·ªåN D·∫∏P H·ªÜ TH·ªêNG
        if: always()
        shell: powershell
        run: |
          Write-Host "üßπ ƒêang d·ªçn d·∫πp h·ªá th·ªëng..."
          net user ducthanggaming /delete > $null 2>&1
          $tailscaleExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
          if (Test-Path $tailscaleExe) { & $tailscaleExe down > $null 2>&1 }
          netsh advfirewall firewall delete rule name="RDP-Premium" > $null 2>&1
          netsh advfirewall firewall delete rule name="RDP-Premium-Out" > $null 2>&1
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force -ErrorAction SilentlyContinue
          Write-Host "‚úÖ D·ªçn d·∫πp ho√†n t·∫•t!" -ForegroundColor Green
