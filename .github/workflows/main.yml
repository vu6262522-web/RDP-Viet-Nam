name: üöÄ SERVER ducthanggaming

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Th·ªùi gian s·ª≠ d·ª•ng'
        required: false
        default: '1_Gi·ªù_30_Ph√∫t_(90m)'
        type: choice
        options:
          - '30_Ph√∫t_(30m)'
          - '1_Gi·ªù_(60m)'
          - '1_Gi·ªù_30_Ph√∫t_(90m)'
          - '2_Gi·ªù_(120m)'
          - '2_Gi·ªù_30_Ph√∫t_(150m)'
          - '3_Gi·ªù_(180m)'
          - '3_Gi·ªù_30_Ph√∫t_(210m)'
          - '4_Gi·ªù_(240m)'
          - '4_Gi·ªù_30_Ph√∫t_(270m)'
          - '5_Gi·ªù_(300m)'
          - '5_Gi·ªù_30_Ph√∫t_(330m)'
          - '6_Gi·ªù_(360m)'

jobs:
  Ducthanggaming-RDP-Setup:
    runs-on: windows-latest
    steps:
      - name: KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG
        shell: powershell
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          chcp 65001 > $null
          
          Write-Host "`n ducthanggaming RDP SERVER" -ForegroundColor Yellow
          Write-Host " Powered by ducthanggaming" -ForegroundColor Green
          Write-Host " Th·ªùi gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta

      - name: C·∫§U H√åNH H·ªÜ TH·ªêNG
        shell: powershell
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389
          netsh advfirewall firewall add rule name="RDP-Premium-Out" dir=out action=allow protocol=TCP localport=3389
          Set-Service -Name TermService -StartupType Automatic
          Start-Service TermService
          Write-Host "‚úÖ C·∫•u h√¨nh RDP ho√†n t·∫•t" -ForegroundColor Green

      - name: üë§ T·∫†O T√ÄI KHO·∫¢N PREMIUM (ƒê√É FIX ·ªîN ƒê·ªäNH)
        shell: powershell
        run: |
          Write-Host "üë§ ƒêANG T·∫†O T√ÄI KHO·∫¢N ducthanggaming" -ForegroundColor Yellow
          
          function New-PremiumPassword {
              $upper = 'ABCDEFGHJKLMNPQRSTUVWXYZ'
              $lower = 'abcdefghijkmnpqrstuvwxyz'
              $numbers = '23456789'
              $all = $upper + $lower + $numbers

              $pw = @()
              $pw += $upper[(Get-Random -Maximum $upper.Length)]
              $pw += $lower[(Get-Random -Maximum $lower.Length)]
              $pw += $numbers[(Get-Random -Maximum $numbers.Length)]
              for ($i = 1; $i -le 5; $i++) { $pw += $all[(Get-Random -Maximum $all.Length)] }
              return (-join ($pw | Sort-Object {Get-Random}))
          }

          if ($env:CUSTOM_RDP_PASS) {
              $matKhau = $env:CUSTOM_RDP_PASS
          } else {
              $matKhau = New-PremiumPassword
          }

          $securePass = ConvertTo-SecureString $matKhau -AsPlainText -Force

          # X√≥a user c≈© n·∫øu t·ªìn t·∫°i (an to√†n h∆°n)
          net user ducthanggaming /delete > $null 2>&1

          # T·∫°o user m·ªõi - d√πng net user ƒë·ªÉ tr√°nh l·ªói New-LocalUser tr√™n m·ªôt s·ªë runner
          net user ducthanggaming "$matKhau" /add /active:yes /expires:never /passwordchg:no
          if ($LASTEXITCODE -ne 0) {
              Write-Host "‚ùå L·ªói t·∫°o user b·∫±ng net user" -ForegroundColor Red
              exit 1
          }

          # Th√™m quy·ªÅn Admin v√† RDP
          net localgroup Administrators ducthanggaming /add
          net localgroup "Remote Desktop Users" ducthanggaming /add

          Write-Host "‚úÖ T√†i kho·∫£n ducthanggaming ƒë√£ t·∫°o th√†nh c√¥ng (Admin + RDP)" -ForegroundColor Green

          echo "RDP_USER=ducthanggaming" >> $env:GITHUB_ENV
          echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV

      - name: üåê C√ÄI ƒê·∫∂T & K·∫æT N·ªêI TAILSCALE (ƒê√É FIX HO√ÄN TO√ÄN)
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        shell: powershell
        run: |
          if (-not $env:TAILSCALE_AUTH_KEY) {
              Write-Host "‚ùå Kh√¥ng t√¨m th·∫•y TAILSCALE_AUTH_KEY secret!" -ForegroundColor Red
              exit 1
          }

          Write-Host "üåê B·∫Øt ƒë·∫ßu c√†i ƒë·∫∑t Tailscale..." -ForegroundColor Yellow

          $msiUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $msiPath = "$env:TEMP\tailscale.msi"

          try {
              Invoke-WebRequest -Uri $msiUrl -OutFile $msiPath -UseBasicParsing
          } catch {
              Write-Host "‚ùå T·∫£i Tailscale th·∫•t b·∫°i: $($_.Exception.Message)" -ForegroundColor Red
              exit 1
          }

          Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $msiPath -Force -ErrorAction SilentlyContinue

          Start-Sleep -Seconds 15

          $tailscaleExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
          if (-not (Test-Path $tailscaleExe)) {
              Write-Host "‚ùå Kh√¥ng t√¨m th·∫•y tailscale.exe sau khi c√†i!" -ForegroundColor Red
              exit 1
          }

          # K·∫øt n·ªëi Tailscale
          & $tailscaleExe up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=ducthanggaming-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset

          if ($LASTEXITCODE -ne 0) {
              Write-Host "‚ùå K·∫øt n·ªëi Tailscale th·∫•t b·∫°i!" -ForegroundColor Red
              exit 1
          }

          Write-Host "‚úÖ Tailscale ƒë√£ k·∫øt n·ªëi th√†nh c√¥ng!" -ForegroundColor Green

          # L·∫•y IP Tailscale (retry m·∫°nh m·∫Ω)
          $ip = $null
          for ($i = 0; $i -lt 30; $i++) {
              $ip = & $tailscaleExe ip -4 2>$null | ForEach-Object Trim
              if (\( ip -match '^(100\.\d{1,3}\.\d{1,3}\.\d{1,3}) \)') {
                  Write-Host "‚úÖ Tailscale IP: $ip" -ForegroundColor Green
                  echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
                  break
              }
              Start-Sleep -Seconds 3
          }

          if (-not $ip) {
              Write-Host "‚ö†Ô∏è Kh√¥ng l·∫•y ƒë∆∞·ª£c IP ‚Üí d√πng fallback 100.100.100.100" -ForegroundColor Yellow
              echo "TAILSCALE_IP=100.100.100.100" >> $env:GITHUB_ENV
          }

      - name: üîç KI·ªÇM TRA K·∫æT N·ªêI RDP (·ªîN ƒê·ªäNH H∆†N)
        shell: powershell
        run: |
          $ip = $env:TAILSCALE_IP
          Write-Host "üîç Ki·ªÉm tra k·∫øt n·ªëi RDP t·ªõi $ip:3389 ..."
          
          $maxRetries = 20
          $success = $false
          for ($i = 1; $i -le $maxRetries; $i++) {
              $result = Test-NetConnection -ComputerName $ip -Port 3389 -WarningAction SilentlyContinue
              if ($result.TcpTestSucceeded) {
                  Write-Host "‚úÖ K·∫øt n·ªëi RDP th√†nh c√¥ng sau $i l·∫ßn th·ª≠!" -ForegroundColor Green
                  $success = $true
                  break
              }
              Start-Sleep -Seconds 5
          }
          
          if (-not $success) {
              Write-Host "‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi RDP sau $maxRetries l·∫ßn th·ª≠." -ForegroundColor Red
              exit 1
          }

      - name: üéâ TH√îNG TIN K·∫æT N·ªêI
        shell: powershell
        run: |
          $matKhau = $env:RDP_PASS
          $ip = $env:TAILSCALE_IP

          \( durationInput = " \){{ github.event.inputs.duration }}"
          switch ($durationInput) {
              "30_Ph√∫t_(30m)"              { $totalMinutes = 30;  $displayTime = "30 ph√∫t" }
              "1_Gi·ªù_(60m)"                { $totalMinutes = 60;  $displayTime = "1 gi·ªù" }
              "1_Gi·ªù_30_Ph√∫t_(90m)"        { $totalMinutes = 90;  $displayTime = "1 gi·ªù 30 ph√∫t" }
              "2_Gi·ªù_(120m)"               { $totalMinutes = 120; $displayTime = "2 gi·ªù" }
              "2_Gi·ªù_30_Ph√∫t_(150m)"       { $totalMinutes = 150; $displayTime = "2 gi·ªù 30 ph√∫t" }
              "3_Gi·ªù_(180m)"               { $totalMinutes = 180; $displayTime = "3 gi·ªù" }
              "3_Gi·ªù_30_Ph√∫t_(210m)"       { $totalMinutes = 210; $displayTime = "3 gi·ªù 30 ph√∫t" }
              "4_Gi·ªù_(240m)"               { $totalMinutes = 240; $displayTime = "4 gi·ªù" }
              "4_Gi·ªù_30_Ph√∫t_(270m)"       { $totalMinutes = 270; $displayTime = "4 gi·ªù 30 ph√∫t" }
              "5_Gi·ªù_(300m)"               { $totalMinutes = 300; $displayTime = "5 gi·ªù" }
              "5_Gi·ªù_30_Ph√∫t_(330m)"       { $totalMinutes = 330; $displayTime = "5 gi·ªù 30 ph√∫t" }
              "6_Gi·ªù_(360m)"               { $totalMinutes = 360; $displayTime = "6 gi·ªù" }
          }

          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $start = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $end = $start.AddMinutes($totalMinutes)

          Write-Host ""
          Write-Host "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê" -ForegroundColor Cyan
          Write-Host "‚îÇ              üéâ K·∫æT N·ªêI TH√ÄNH C√îNG!              ‚îÇ" -ForegroundColor Cyan
          Write-Host "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" -ForegroundColor Cyan
          Write-Host "‚îÇ üåê  ƒê·ªãa ch·ªâ: $ip" -ForegroundColor White
          Write-Host "‚îÇ üë§  T√†i kho·∫£n: ducthanggaming" -ForegroundColor White
          Write-Host "‚îÇ üîê  M·∫≠t kh·∫©u: $matKhau" -ForegroundColor White
          Write-Host "‚îÇ ‚è∞  Th·ªùi l∆∞·ª£ng: $displayTime" -ForegroundColor White
          Write-Host "‚îÇ üïê  B·∫Øt ƒë·∫ßu: $($start.ToString('HH:mm:ss dd/MM/yyyy'))" -ForegroundColor White
          Write-Host "‚îÇ üïê  K·∫øt th√∫c: $($end.ToString('HH:mm:ss dd/MM/yyyy'))" -ForegroundColor White
          Write-Host "‚îÇ üìç  Port: 3389" -ForegroundColor White
          Write-Host "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò" -ForegroundColor Cyan

          echo "TOTAL_MINUTES=$totalMinutes" >> $env:GITHUB_ENV

      - name: ‚è≥ DUY TR√å PHI√äN L√ÄM VI·ªÜC
        shell: powershell
        run: |
          $totalMinutes = [int]$env:TOTAL_MINUTES
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $startTime = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $endTime = $startTime.AddMinutes($totalMinutes)

          Write-Host "üîÑ B·∫Øt ƒë·∫ßu duy tr√¨ phi√™n l√†m vi·ªác ƒë·∫øn $($endTime.ToString('HH:mm:ss dd/MM/yyyy'))"

          do {
              $current = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
              $left = $endTime - $current
              if ($left.TotalSeconds -le 0) { break }
              Write-Host "‚è≥ Th·ªùi gian c√≤n l·∫°i: $($left.Days)d $($left.Hours)h $($left.Minutes)m $($left.Seconds)s" -ForegroundColor Cyan
              Start-Sleep -Seconds 10
          } while ($true)

          Write-Host "üéØ H·∫øt th·ªùi gian!"

      - name: üßπ D·ªåN D·∫∏P H·ªÜ TH·ªêNG
        if: always()
        shell: powershell
        run: |
          Write-Host "üßπ B·∫Øt ƒë·∫ßu d·ªçn d·∫πp..."
          net user ducthanggaming /delete > $null 2>&1
          & "$env:ProgramFiles\Tailscale\tailscale.exe" down > $null 2>&1
          netsh advfirewall firewall delete rule name="RDP-Premium" > $null 2>&1
          netsh advfirewall firewall delete rule name="RDP-Premium-Out" > $null 2>&1
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force
          Write-Host "‚úÖ D·ªçn d·∫πp ho√†n t·∫•t!" -ForegroundColor Green
